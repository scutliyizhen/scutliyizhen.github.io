---
layout:     post
title:      跨平台架构演进  
date:       2019-07-01
author:     robertyzli
header-img: Resources/Posts/liyizhen_blog_cross_platform_bg.jpg
catalog: true
tags:
    - Hybrid
    - Weex
    - Swift
    - 跨平台
    - 架构演进 
---

> 本文主要介绍51信用卡跨平台架构的演进情况，对混合开发模式存在的一些共性问题给出解决方案。

自2015年Facebook开源首个跨平台UI框架ReactNative(RN)，到2016年阿里开源Weex，2017年Google推出Flutter跨平台UI框架。跨平台解决方案在移动端正处于蓬勃发展的状态，而目前大部分企业基本都是原生与跨平台的混合开发模式，无论是业务需要还是移动平台技术的差异特性，都很难做到完全跨平台。因此，混合开发模式下的开发会面临更多的问题。

2017年我进入51信用卡，那时客户端与前端使用的是Hybrid混合开发模式。在51的两年基本上就是处于不断填坑状态，开始接触WebKit的时候Hybrid本身并没有架构的概念，很多代码基本都是以功能逻辑融合在一起，每当新增需求都很困难担心改动点是否全面有遗漏；而当Weex跨平台接入之后又依赖Hybrid，出现了运行时安全、耦合依赖等问题，本文会详细阐述遇到的实际问题以及是如何优化架构解决问题。

###   一.早期Hybrid架构  
<table>
    <thead>
        <tr>
            <th>Hybrid架构图</th>
            <th>混合开发通信逻辑架构</th>
            <th>备注</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><img src="/Resources/Posts/liyizhen_blog_cross_platform_old.png"/></td>
            <td><img src="/Resources/Posts/liyizhen_blog_cross_platform_old_pg.png"/></td>
            <td>架构图是我2017年刚进公司的时候在公司的wiki上翻到的，对应的基础库代码也就是早期的WebAppKit。</td>
        </tr>
    </tbody>
</table>
  
主要包含的功能点：     
通信、Hybrid API、Event、URL配置、调试工具、UniversalLink、容器UI。  
不包含的功能模块：离线、监控   
面临的问题主要有：   
1.功能模块划分不清晰：以上所有的功能点都放在WebAppKit基础库中，并且在基础库中没有合理的划分模块。  
2.视图容器逻辑不清晰：各种UI组件初始化、WebView（WK/UI）配置以及回调、导航控制逻辑等等都放在WebController中，各种逻辑通过不断的添加属性来区分，当时该文件有1000多行的代码，对于后续扩展监控、离线、注入脚本则会带来很大的困难，不好维护。     
3.接口不可控问题：比如在视图中WebView完全暴露，而子类可以在任意时机操作WebView，引入不可控因素。  
4.WebKit可扩展性、耦合性问题：业务侧只能使用继承的方式使用基础WebController，不支持组合的方式，并且不能单独使用WebView。比如业务同学单独使用WebView做运营广告位，只能使用野路子的方式，操作WebController中的View。    
5. PG(原生API)设计问题：线程安全、API与框架稳定性问题、可移植性与可扩展性问题、运行时安全问题等等，在PG设计演进中会详细介绍。  

###  二.跨平台架构    
<table>
    <thead>
        <tr>
            <th>跨平台架构图</th>
            <th>混合开发通信逻辑架构</th>
            <th>备注</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><img src="/Resources/Posts/liyizhen_blog_cross_platform_weex_hybrid.png"/></td>
            <td><img src="/Resources/Posts/liyizhen_blog_cross_platform_weex_hybrid_pg.png"/></td>
            <td>Weex接入</td>
        </tr>
    </tbody>
</table>

###  三.架构演进  
<table>
    <thead>
        <tr>
            <th>跨平台架构图</th>
            <th>混合开发通信逻辑架构</th>
            <th>备注</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><img src="/Resources/Posts/liyizhen_blog_cross_platform_new.jpg"  width="1940" height="1156"/></td>
            <td><img src="/Resources/Posts/liyizhen_blog_cross_platform_pg_core.jpg" width="2084" height="1170"/></td>
            <td>新的架构演进</td>
        </tr>
    </tbody>
</table>


<!-- ####  1.Hybrid容器    
UI层：WebView（WK/UI）、组件（加载loading、异常错误、进度条等）、Controller、WebView接口扩展   
Engine层：主要处理Web容器基础逻辑，分为WKEngine、UIEngine，比如离线、监控、注入脚本、路由、与PGCore层的通信等核心逻辑。  
注入脚本模块：区分WKWebView注入脚本、UIWebView注入脚本（与离线技术方案相似，涉及业务敏感性所以不透露太多）。  
Data层：处理WebUA与Cookie的问题。 -->

<!-- ####  2.Weex容器   

####  3.头部容器  

####  4.离线

####  5.EventBus  

###  四.PG设计演进 -->
